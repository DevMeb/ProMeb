import{p as I,e as y,i as F,q as S,x as D,s as A,o as M,c as d,a as c,b as e,w as H,t as b,u as g,f as $,g as T,k as C,y as U,F as L,r as N,n as V,j as O}from"./app-Ck7-LjM1.js";import{u as R}from"./prestations-C7BO4rbf.js";const z=I("dashboard",()=>{const n=y(null),f=y(new Date().toISOString().substring(0,7)),m=y(0),x=y(!1),p=y(null);async function w(){var a,o;x.value=!0,p.value=null;try{const i=await S.get("/api/dashboard",{params:{month:f.value}});n.value=i.data}catch(i){p.value=((o=(a=i.response)==null?void 0:a.data)==null?void 0:o.error)||i.message}finally{x.value=!1}}const u=F(()=>n.value.factures_paid.reduce((a,o)=>a+o.montant_total,0)),k=F(()=>n.value.factures_unpaid.reduce((a,o)=>a+o.montant_total,0)),v=F(()=>n.value.prestations_unbilled.reduce((a,o)=>{var i;return a+o.heures*(((i=o.taux_horaire)==null?void 0:i.taux)??0)},0)),h=F(()=>u.value+k.value+v.value),r=F(()=>u.value-h.value),j=F(()=>n.value?parseFloat((u.value*(1-m.value/100)).toFixed(2)):0);function s(a){n.value.factures_unpaid=n.value.factures_unpaid.filter(o=>o.id!==a.id),n.value.factures_paid.push(a)}return{dashboardData:n,period:f,loading:x,error:p,fetchDashboard:w,factureFromUnpaidToPaid:s,caBilledWithTax:j,taxe:m,caBilled:u,caAttendu:h,difference:r}}),q=I("invoices",()=>{const n=y([]),f=y({}),m=y({}),x=z();function p(s){s?f.value[s]=null:f.value={}}function w(s,a){m.value[s]=a}async function u({operation:s,request:a,onSuccess:o,onError:i}){var P,_,t;p(s),w(s,!0);try{const l=await a();return o?o(l):l}catch(l){console.error(l),i?i(l):((P=l.response)==null?void 0:P.status)===422?f.value.validationErrors=l.response.data.errors:(f.value[s]=((t=(_=l.response)==null?void 0:_.data)==null?void 0:t.message)||"Une erreur est survenue.",D("error",f.value[s]))}finally{w(s,!1)}}async function k(){return u({operation:"fetch",request:()=>S.get("/api/factures"),onSuccess:s=>{n.value=s.data.factures}})}async function v(s){return u({operation:"add",request:()=>S.post("/api/factures",s),onSuccess:a=>{n.value.push(a.data.facture),x.dashboardData&&x.fetchDashboard(),D("success",a.data.message)}})}async function h(s){return u({operation:"delete",request:()=>S.delete(`/api/factures/${s}`),onSuccess:a=>{n.value=n.value.filter(o=>o.id!==s),D("success",a.data.message)}})}async function r(s){return u({operation:"pdf",request:()=>S.get(`/api/factures/${s}/pdf`,{responseType:"blob"}),onSuccess:a=>URL.createObjectURL(new Blob([a.data],{type:"application/pdf"})),onError:async a=>{if(a.response.headers["content-type"]==="application/json"){const i=await a.response.data.text(),P=JSON.parse(i);f.value.pdf="Impossible de charger le PDF",D("error",P.message)}}})}async function j(s){return u({operation:"paid",request:()=>S.patch(`/api/factures/${s}/paid`),onSuccess:a=>{if(x.dashboardData){const i=a.data.facture;x.factureFromUnpaidToPaid(i)}const o=n.value.findIndex(i=>i.id===s);o!==-1&&(n.value[o]=a.data.facture),D("success",a.data.message)}})}return{invoices:n,errors:f,loading:m,fetchInvoices:k,addInvoice:v,deleteInvoice:h,clearErrors:p,getInvoicePdf:r,paid:j}}),E={class:"fixed inset-0 bg-black/50 flex items-center justify-center z-50"},J={class:"bg-white p-6 rounded-lg shadow-lg w-4/5 h-4/5 relative"},W={class:"text-xl font-semibold text-gray-800 mb-4"},G={key:0,class:"text-red-500 text-center"},K={key:1,class:"flex flex-col items-center justify-center space-y-4 h-full"},Q=["href"],X={key:2,class:"flex flex-col items-center justify-center h-full"},Y={key:0,class:"flex flex-col items-center space-y-2"},Z=["src"],ee={key:4,class:"flex flex-col items-center justify-center h-full"},te={key:0,class:"flex flex-col items-center space-y-2"},He={__name:"FacturePdfModal",props:{invoice:Object},emits:["close"],setup(n,{emit:f}){const m=n,x=f,p=q(),{getInvoicePdf:w}=p,{loading:u,errors:k}=A(p),v=y(""),h=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);M(async()=>{v.value=await w(m.invoice.id)});function r(){x("close")}return(j,s)=>(c(),d("div",E,[e("div",{onClick:H(r,["self"]),class:"absolute inset-0"}),e("div",J,[e("button",{onClick:r,class:"absolute top-3 right-3 text-gray-600 hover:text-gray-800"}," ✖ "),e("h2",W," 🧾 Facture #"+b(n.invoice.id),1),g(k).pdf?(c(),d("div",G,[e("p",null,"❌ "+b(g(k).pdf),1)])):g(h)&&v.value?(c(),d("div",K,[s[0]||(s[0]=e("p",{class:"text-gray-700"},"Le PDF ne peut pas être affiché inline sur mobile.",-1)),e("a",{href:v.value,download:"facture.pdf",class:"px-4 py-2 bg-indigo-600 text-white rounded-md font-semibold hover:bg-indigo-500 transition"}," Télécharger le PDF ",8,Q)])):g(h)&&!v.value?(c(),d("div",X,[g(u).pdf?(c(),d("div",Y,s[1]||(s[1]=[e("span",{class:"animate-spin border-4 border-gray-400 border-t-transparent rounded-full w-10 h-10"},null,-1),e("p",{class:"text-gray-500"},"Chargement du PDF...",-1)]))):$("",!0)])):v.value?(c(),d("iframe",{key:3,src:v.value,class:"w-full h-full"},null,8,Z)):(c(),d("div",ee,[g(u).pdf?(c(),d("div",te,s[2]||(s[2]=[e("span",{class:"animate-spin border-4 border-gray-400 border-t-transparent rounded-full w-10 h-10"},null,-1),e("p",{class:"text-gray-500"},"Chargement du PDF...",-1)]))):$("",!0)]))])]))}},se={class:"fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-md z-50"},ae={class:"bg-gray-900 p-8 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-auto border border-gray-800"},oe={class:"mt-6"},ne={class:"flex flex-col text-lg font-semibold text-white mb-4 flex items-center gap-4"},re={class:"text-sm bg-gray-800 text-gray-400 px-3 py-1 rounded-full"},le={key:0,class:"p-6 text-center rounded-xl border-2 border-dashed border-gray-800 hover:border-indigo-500 transition-colors"},ie={key:1,class:"space-y-3"},de={class:"flex items-center justify-center text-xl text-white mb-4"},ce=["value"],ue={class:"ml-4 flex-1"},fe={class:"flex items-center justify-center gap-3"},pe={class:"font-bold text-md bg-gray-900 text-gray-400 px-2 py-1 rounded-full"},ge={class:"grid grid-cols-2 gap-2 mt-2 font-bold"},xe={class:"flex items-center justify-center gap-2 text-lg"},ve={class:"text-gray-300"},be={class:"flex items-center justify-center gap-2 text-lg"},ye={class:"text-gray-300 truncate"},he={class:"flex items-center justify-center gap-2 text-lg"},me={class:"text-gray-300 truncate"},_e={class:"flex items-center justify-center gap-2 text-lg"},we={class:"text-gray-300 truncate"},ke={key:0,class:"mt-6 bg-gray-800 p-4 rounded-xl border border-gray-700"},je={class:"space-y-2"},Pe={class:"flex justify-between items-center"},Fe={class:"text-white font-medium"},Se={class:"flex justify-between items-center"},De={class:"text-indigo-400 font-bold"},$e={class:"flex justify-between items-center"},Te={class:"text-green-400 font-bold"},Ce={key:1,class:"mt-6 flex flex-col sm:flex-row justify-end gap-3"},Ue=["disabled"],Ie={key:0,class:"animate-spin mr-2"},Ae={key:1},Me={key:2,class:"mt-4 p-3 bg-red-500/10 text-red-400 rounded-lg border border-red-500/30 flex items-center gap-2"},Le={__name:"FactureFormModal",emits:["close"],setup(n,{emit:f}){const m=f,x=R(),{unbilledPrestations:p}=A(x),{fetchPrestations:w}=x,u=q(),{addInvoice:k,loading:v,errors:h}=u;M(()=>{w()});const r=y([]),j=y(!1),s=()=>{j.value?r.value=[...p.value]:r.value=[]},a=F(()=>r.value.reduce((_,t)=>_+parseFloat(t.heures),0)),o=F(()=>r.value.reduce((_,t)=>_+t.taux_horaire.taux*t.heures,0));async function i(){if(!r.value.length)return;const _={prestations:r.value.map(t=>t.id)};await k(_),P()}const P=()=>{m("close")};return(_,t)=>(c(),d("div",se,[e("div",ae,[e("div",{class:"flex justify-between items-center pb-4 border-b border-gray-800"},[t[2]||(t[2]=e("h2",{class:"text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400"}," 🧾 Nouvelle Facture ",-1)),e("button",{onClick:P,class:"text-gray-400 hover:text-white transition-transform hover:scale-110"}," ✕ ")]),e("div",oe,[e("h3",ne,[t[3]||(t[3]=T(" 📋 Prestations disponibles ")),e("span",re,b(g(p).length)+" non facturées ",1)]),g(p).length===0?(c(),d("div",le,t[4]||(t[4]=[e("div",{class:"text-4xl mb-3"},"🎉",-1),e("p",{class:"text-gray-400"},"Aucune prestations à facturées !",-1)]))):(c(),d("div",ie,[e("label",de,[C(e("input",{type:"checkbox","onUpdate:modelValue":t[0]||(t[0]=l=>j.value=l),onChange:s,class:"mr-2"},null,544),[[U,j.value]]),t[5]||(t[5]=T(" Tout sélectionner "))]),(c(!0),d(L,null,N(g(p),l=>(c(),d("label",{key:l.id,class:V(["group flex items-center p-4 rounded-xl border border-gray-800 hover:border-indigo-500 bg-gray-800/50 cursor-pointer transition-all",{"border-indigo-500 bg-indigo-500/10":r.value.includes(l)}])},[C(e("input",{type:"checkbox","onUpdate:modelValue":t[1]||(t[1]=B=>r.value=B),value:l,class:"mt-1 h-5 w-5 rounded border-gray-700 bg-gray-800 checked:bg-indigo-500 checked:border-indigo-500 focus:ring-indigo-500/50"},null,8,ce),[[U,r.value]]),e("div",ue,[e("div",fe,[e("span",pe,b(g(O)(l.date)),1)]),e("div",ge,[e("div",xe,[t[6]||(t[6]=e("span",{class:"text-gray-500"},"🕒",-1)),e("span",ve,b(l.heures)+"h",1)]),e("div",be,[t[7]||(t[7]=e("span",{class:"text-gray-500"},"📍",-1)),e("span",ye,b(l.adresse),1)]),e("div",he,[t[8]||(t[8]=e("span",{class:"text-gray-500"},"👤",-1)),e("span",me,b(l.client.nom),1)]),e("div",_e,[t[9]||(t[9]=e("span",{class:"text-gray-500"},"💰",-1)),e("span",we,b(l.taux_horaire.taux)+" € / h",1)])])])],2))),128))]))]),r.value.length!==0?(c(),d("div",ke,[t[13]||(t[13]=e("h3",{class:"text-lg font-semibold text-white mb-3 flex items-center gap-2"}," 📝 Récapitulatif ",-1)),e("div",je,[e("div",Pe,[t[10]||(t[10]=e("span",{class:"text-gray-400"},"Prestations sélectionnées :",-1)),e("span",Fe,b(r.value.length),1)]),e("div",Se,[t[11]||(t[11]=e("span",{class:"text-gray-400"},"Total heures :",-1)),e("span",De,b(a.value)+"h",1)]),e("div",$e,[t[12]||(t[12]=e("span",{class:"text-gray-400"},"Montant HT :",-1)),e("span",Te,b(o.value)+" €",1)])])])):$("",!0),r.value.length!==0?(c(),d("div",Ce,[e("button",{onClick:P,class:"px-6 py-3 rounded-xl font-semibold transition-all bg-gray-700 hover:bg-gray-600 text-white"}," Annuler "),e("button",{onClick:i,class:"px-6 py-3 rounded-xl font-semibold transition-all bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white flex items-center justify-center",disabled:g(v).add||r.value.length===0},[g(v).add?(c(),d("span",Ie,"🌀")):(c(),d("span",Ae,"✅")),t[14]||(t[14]=T(" Créer la Facture "))],8,Ue)])):$("",!0),g(h).add?(c(),d("div",Me," ⚠️ "+b(g(h).add),1)):$("",!0)])]))}};export{Le as _,q as a,He as b,z as u};
