import{m as q,h as y,p as F,s as M,i as I,a as n,o as l,b as e,l as S,t as h,u as x,d as C,c as T,e as E,F as H,r as L,n as R,w as U,q as V,v as B}from"./app-CzuueUTO.js";import{n as j,u as N,d as O,v as Y}from"./prestations-AgWsYLdo.js";const z=q("dashboard",()=>{const d=y(null),f=y(new Date().toISOString().substring(0,7)),v=y(!1),c=y(null);async function g(){var _,u;v.value=!0,c.value=null;try{const i=await F.get("/api/dashboard",{params:{month:f.value},withCredentials:!0});d.value=i.data}catch(i){c.value=((u=(_=i.response)==null?void 0:_.data)==null?void 0:u.error)||i.message}finally{v.value=!1}}return{dashboardData:d,period:f,loading:v,error:c,fetchDashboard:g}}),A=q("invoices",()=>{const d=y([]),f=y({}),v=y({}),c=z();function g(s){s?f.value[s]=null:f.value={}}function _(s,r){v.value[s]=r}async function u({operation:s,request:r,onSuccess:a}){var t,m,P;g(s),_(s,!0);try{const $=await r();return a&&a($),$}catch($){throw((t=$.response)==null?void 0:t.status)===422?f.value.validationErrors=$.response.data.errors:(f.value[s]=((P=(m=$.response)==null?void 0:m.data)==null?void 0:P.message)||"Une erreur est survenue.",j("error",f.value[s])),console.error($),$}finally{_(s,!1)}}async function i(){return u({operation:"fetch",request:()=>F.get("/api/factures",{withCredentials:!0}),onSuccess:s=>{d.value=s.data}})}async function p(s){return u({operation:"add",request:()=>F.post("/api/factures",s),onSuccess:r=>{d.value.push(r.data.data||r.data),c.dashboardData&&c.fetchDashboard(),j("success",r.data.message||"Facture ajout√©e avec succ√®s.")}})}async function w(s){return u({operation:"delete",request:()=>F.delete(`/api/factures/${s}`),onSuccess:r=>{d.value=d.value.filter(a=>a.id!==s),j("success",r.data.message||"Facture supprim√©e avec succ√®s.")}})}const o=new Map;async function k(s){if(o.has(s))return o.get(s);try{const r=await u({operation:"pdf",request:()=>F.get(`/api/factures/${s}/pdf`,{withCredentials:!0,responseType:"blob"})});if(!r||!r.data)throw new Error("R√©ponse invalide lors de la r√©cup√©ration du PDF.");const a=URL.createObjectURL(new Blob([r.data],{type:"application/pdf"}));return o.set(s,a),a}catch(r){throw console.error(`Erreur lors de la r√©cup√©ration du PDF de la facture ${s} :`,r),new Error("Impossible de r√©cup√©rer le PDF.")}}async function b(s,r){return u({operation:"sendEmail",request:()=>F.post(`/api/factures/${s}/send-email`,{emails:r}),onSuccess:a=>{const t=a.data.data,m=d.value.findIndex(P=>P.id===s);m!==-1?d.value[m]=t:console.warn(`‚ö†Ô∏è Facture ${s} non trouv√©e dans le store invoices.`),c.dashboardData&&c.fetchDashboard(),j("success",a.data.message||"Facture envoy√©e avec succ√®s.")}})}async function D(s){return u({operation:"paid",request:()=>F.patch(`/api/factures/${s.id}/paid`),onSuccess:r=>{const a=r.data.data,t=d.value.findIndex(m=>m.id===s.id);t!==-1?d.value[t]=a:console.warn(`‚ö†Ô∏è Facture ${s.id} non trouv√©e dans le store invoices.`),c.dashboardData&&c.fetchDashboard(),j("success",r.data.message||"Facture marqu√©e comme pay√©e.")}})}return{invoices:d,errors:f,loading:v,fetchInvoices:i,addInvoice:p,deleteInvoice:w,getInvoicePdf:k,clearErrors:g,sendEmail:b,invoicePaid:D}}),G={class:"fixed inset-0 bg-black/50 flex items-center justify-center z-50"},J={class:"bg-white p-6 rounded-lg shadow-lg w-4/5 h-4/5 relative"},K={class:"text-xl font-semibold text-gray-800 mb-4"},Q={key:0,class:"text-red-500 text-center"},W={key:1,class:"flex flex-col items-center justify-center space-y-4 h-full"},X=["href"],Z={key:2,class:"flex flex-col items-center justify-center h-full"},ee={key:0,class:"flex flex-col items-center space-y-2"},te=["src"],se={key:4,class:"flex flex-col items-center justify-center h-full"},ae={key:0,class:"flex flex-col items-center space-y-2"},Oe={__name:"FacturePdfModal",props:{invoice:Object},emits:["close"],setup(d,{emit:f}){const v=d,c=f,g=A(),{getInvoicePdf:_}=g,{loading:u}=M(g),i=y(""),p=y(null),w=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);I(async()=>{try{p.value=null,i.value=null,i.value=await _(v.invoice.id)}catch{p.value="Impossible de charger le PDF."}});function o(){c("close")}return(k,b)=>(l(),n("div",G,[e("div",{onClick:S(o,["self"]),class:"absolute inset-0"}),e("div",J,[e("button",{onClick:o,class:"absolute top-3 right-3 text-gray-600 hover:text-gray-800"}," ‚úñ "),e("h2",K," üßæ Facture #"+h(d.invoice.id),1),p.value?(l(),n("div",Q,[e("p",null,"‚ùå "+h(p.value),1)])):x(w)&&i.value?(l(),n("div",W,[b[0]||(b[0]=e("p",{class:"text-gray-700"},"Le PDF ne peut pas √™tre affich√© inline sur mobile.",-1)),e("a",{href:i.value,download:"facture.pdf",class:"px-4 py-2 bg-indigo-600 text-white rounded-md font-semibold hover:bg-indigo-500 transition"}," T√©l√©charger le PDF ",8,X)])):x(w)&&!i.value?(l(),n("div",Z,[x(u).pdf?(l(),n("div",ee,b[1]||(b[1]=[e("span",{class:"animate-spin border-4 border-gray-400 border-t-transparent rounded-full w-10 h-10"},null,-1),e("p",{class:"text-gray-500"},"Chargement du PDF...",-1)]))):C("",!0)])):i.value?(l(),n("iframe",{key:3,src:i.value,class:"w-full h-full"},null,8,te)):(l(),n("div",se,[x(u).pdf?(l(),n("div",ae,b[2]||(b[2]=[e("span",{class:"animate-spin border-4 border-gray-400 border-t-transparent rounded-full w-10 h-10"},null,-1),e("p",{class:"text-gray-500"},"Chargement du PDF...",-1)]))):C("",!0)]))])]))}},re={class:"fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-md z-50"},oe={class:"bg-gray-900 p-8 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-auto border border-gray-800"},ne={class:"mt-6"},le={class:"text-lg font-semibold text-white mb-4 flex items-center gap-2"},ie={class:"text-sm bg-gray-800 text-gray-400 px-3 py-1 rounded-full"},de={key:0,class:"p-6 text-center rounded-xl border-2 border-dashed border-gray-800 hover:border-indigo-500 transition-colors"},ce={key:1,class:"space-y-3"},ue=["value"],fe={class:"ml-4 flex-1"},pe={class:"flex items-center gap-3"},me={class:"font-mono text-sm text-indigo-400"},ve={class:"text-xs bg-gray-900 text-gray-400 px-2 py-1 rounded-full"},ge={class:"grid grid-cols-2 gap-2 mt-2"},be={class:"flex items-center gap-2 text-sm"},xe={class:"text-gray-300"},he={class:"flex items-center gap-2 text-sm"},ye={class:"text-gray-300 truncate"},_e={class:"mt-6 bg-gray-800 p-4 rounded-xl border border-gray-700"},we={key:0,class:"space-y-2"},ke={class:"flex justify-between items-center"},$e={class:"text-white font-medium"},Fe={class:"flex justify-between items-center"},De={class:"text-indigo-400 font-bold"},Pe={class:"flex justify-between items-center"},je={class:"text-green-400 font-bold"},Ce={key:1,class:"text-center py-3 text-gray-500"},Ee={class:"mt-6 flex flex-col sm:flex-row justify-end gap-3"},Se=["disabled"],Me={key:0,class:"animate-spin mr-2"},Ae={key:1},Te={key:0,class:"mt-4 p-3 bg-red-500/10 text-red-400 rounded-lg border border-red-500/30 flex items-center gap-2"},qe=20,Ye={__name:"FactureFormModal",emits:["close"],setup(d,{emit:f}){const v=f,c=N(),{unbilledPrestations:g}=M(c),{fetchPrestations:_}=c,u=A(),{addInvoice:i,loading:p,errors:w}=u;I(()=>{_()});const o=y([]),k=T(()=>o.value.reduce((a,t)=>a+parseFloat(t.heures),0)),b=T(()=>k.value*qe),D=a=>O(a).format("DD/MM/YYYY");async function s(){if(!o.value.length)return;const a={prestations:o.value.map(t=>t.id)};try{await i(a),v("close")}catch(t){console.error("Erreur lors de la cr√©ation de la facture :",t)}}const r=()=>{v("close")};return(a,t)=>(l(),n("div",re,[e("div",oe,[e("div",{class:"flex justify-between items-center pb-4 border-b border-gray-800"},[t[1]||(t[1]=e("h2",{class:"text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400"}," üßæ Nouvelle Facture ",-1)),e("button",{onClick:r,class:"text-gray-400 hover:text-white transition-transform hover:scale-110"}," ‚úï ")]),e("div",ne,[e("h3",le,[t[2]||(t[2]=E(" üìã Prestations disponibles ")),e("span",ie,h(x(g).length)+" non factur√©es ",1)]),x(g).length===0?(l(),n("div",de,t[3]||(t[3]=[e("div",{class:"text-4xl mb-3"},"üéâ",-1),e("p",{class:"text-gray-400"},"Toutes les prestations sont factur√©es !",-1)]))):(l(),n("div",ce,[(l(!0),n(H,null,L(x(g),m=>(l(),n("label",{key:m.id,class:R(["group flex items-start p-4 rounded-xl border border-gray-800 hover:border-indigo-500 bg-gray-800/50 cursor-pointer transition-all",{"border-indigo-500 bg-indigo-500/10":o.value.includes(m)}])},[U(e("input",{type:"checkbox","onUpdate:modelValue":t[0]||(t[0]=P=>o.value=P),value:m,class:"mt-1 h-5 w-5 rounded border-gray-700 bg-gray-800 checked:bg-indigo-500 checked:border-indigo-500 focus:ring-indigo-500/50"},null,8,ue),[[V,o.value]]),e("div",fe,[e("div",pe,[e("span",me,"#"+h(m.id),1),e("span",ve,h(D(m.date)),1)]),e("div",ge,[e("div",be,[t[4]||(t[4]=e("span",{class:"text-gray-500"},"üïí",-1)),e("span",xe,h(m.heures)+"h",1)]),e("div",he,[t[5]||(t[5]=e("span",{class:"text-gray-500"},"üìç",-1)),e("span",ye,h(m.adresse),1)])])])],2))),128))]))]),e("div",_e,[t[9]||(t[9]=e("h3",{class:"text-lg font-semibold text-white mb-3 flex items-center gap-2"}," üìù R√©capitulatif ",-1)),o.value.length?(l(),n("div",we,[e("div",ke,[t[6]||(t[6]=e("span",{class:"text-gray-400"},"Prestations s√©lectionn√©es :",-1)),e("span",$e,h(o.value.length),1)]),e("div",Fe,[t[7]||(t[7]=e("span",{class:"text-gray-400"},"Total heures :",-1)),e("span",De,h(k.value)+"h",1)]),e("div",Pe,[t[8]||(t[8]=e("span",{class:"text-gray-400"},"Montant HT :",-1)),e("span",je,h(b.value)+" ‚Ç¨",1)])])):(l(),n("div",Ce," Aucune prestation s√©lectionn√©e "))]),e("div",Ee,[e("button",{onClick:r,class:"px-6 py-3 rounded-xl font-semibold transition-all bg-gray-700 hover:bg-gray-600 text-white"}," Annuler "),e("button",{onClick:s,class:"px-6 py-3 rounded-xl font-semibold transition-all bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white flex items-center justify-center",disabled:x(p).add||o.value.length===0},[x(p).add?(l(),n("span",Me,"üåÄ")):(l(),n("span",Ae,"‚úÖ")),t[10]||(t[10]=E(" Cr√©er la Facture "))],8,Se)]),x(w).add?(l(),n("div",Te," ‚ö†Ô∏è "+h(x(w).add),1)):C("",!0)])]))}},Ie={class:"fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-md"},Ue={class:"bg-white p-6 rounded-xl shadow-xl w-[90%] sm:w-96 transform transition-all animate-fade-in"},He={key:0,class:"error-message"},Le={class:"flex justify-end space-x-3 mt-4"},Re=["disabled"],Ve={key:0,class:"animate-spin mr-2"},ze={__name:"FactureMailModal",props:{invoice:Object},emits:["close"],setup(d,{emit:f}){var k,b,D,s;const v=d,c=f,g=A(),{sendEmail:_}=g,{loading:u}=M(g),i=y(((s=(D=(b=(k=v.invoice)==null?void 0:k.reservation)==null?void 0:b.renter)==null?void 0:D.tutor)==null?void 0:s.email)||""),p=y({}),w=async()=>{p.value={};const r=i.value.split(",").map(t=>t.trim()).filter(t=>t.length>0);if(r.filter(t=>!Y(t)).length>0){p.value.emailAddress="Adresse(s) email invalide(s)";return}try{await _(v.invoice.id,r),o()}catch(t){console.error("Erreur lors de l'envoi de la facture par email :",t)}},o=()=>{p.value={},c("close")};return(r,a)=>(l(),n("div",Ie,[e("div",{onClick:S(o,["self"]),class:"fixed inset-0"}),e("div",Ue,[e("div",{class:"flex items-center justify-between border-b pb-2"},[a[1]||(a[1]=e("h2",{class:"text-xl font-semibold text-gray-800 flex items-center"}," üì© Envoyer la facture par email ",-1)),e("button",{onClick:o,class:"text-gray-500 hover:text-gray-700 transition"},"‚úñÔ∏è")]),e("form",{onSubmit:S(w,["prevent"]),class:"mt-4 space-y-4"},[e("div",null,[a[2]||(a[2]=e("label",{for:"email",class:"block text-sm font-medium text-gray-700"},[E(" Adresse(s) email(s) "),e("span",{class:"text-gray-500"},'(s√©par√©es par ",")')],-1)),U(e("input",{type:"text","onUpdate:modelValue":a[0]||(a[0]=t=>i.value=t),class:"w-full border p-2 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500",placeholder:"ex: user1@example.com; user2@example.com"},null,512),[[B,i.value]]),p.value.emailAddress?(l(),n("p",He,h(p.value.emailAddress),1)):C("",!0)]),e("div",Le,[e("button",{type:"button",onClick:o,class:"btn-secondary"},"Annuler"),e("button",{type:"submit",class:"btn-primary flex items-center",disabled:x(u).sendEmail},[x(u).sendEmail?(l(),n("span",Ve,"‚è≥")):C("",!0),a[3]||(a[3]=E(" Envoyer "))],8,Re)])],32)])]))}};export{Oe as _,A as a,ze as b,Ye as c,z as u};
